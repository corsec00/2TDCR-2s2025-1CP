# Network Scanner Azure Function PowerShell

Uma Azure Function em **PowerShell** que executa scan de rede periodicamente (a cada 10 minutos) para detectar m√°quinas Windows e Linux usando o valor TTL do ICMP/Ping. **Otimizado para Windows 11**.

## üéØ Funcionalidades

- **Scan Autom√°tico**: Executa a cada 10 minutos via Timer Trigger
- **Detec√ß√£o de SO**: Identifica Windows, Linux e dispositivos de rede baseado no TTL
- **API REST**: Endpoints para execu√ß√£o manual e health check
- **Paraleliza√ß√£o**: Scan r√°pido usando ForEach-Object -Parallel
- **Logging**: Logs detalhados para Application Insights
- **Configur√°vel**: Rede CIDR e par√¢metros via vari√°veis de ambiente
- **100% PowerShell**: Sem depend√™ncias Python ou outras linguagens

## üèóÔ∏è Arquitetura

```
network-scanner-powershell/
‚îú‚îÄ‚îÄ TimerTrigger/
‚îÇ   ‚îú‚îÄ‚îÄ run.ps1              # Timer trigger (executa a cada 10 min)
‚îÇ   ‚îî‚îÄ‚îÄ function.json        # Configura√ß√£o do timer
‚îú‚îÄ‚îÄ HttpTrigger/
‚îÇ   ‚îú‚îÄ‚îÄ run.ps1              # HTTP trigger para scan manual
‚îÇ   ‚îî‚îÄ‚îÄ function.json        # Configura√ß√£o HTTP
‚îú‚îÄ‚îÄ HealthCheck/
‚îÇ   ‚îú‚îÄ‚îÄ run.ps1              # Health check endpoint
‚îÇ   ‚îî‚îÄ‚îÄ function.json        # Configura√ß√£o health check
‚îú‚îÄ‚îÄ Modules/
‚îÇ   ‚îî‚îÄ‚îÄ NetworkScanner.ps1   # M√≥dulo principal de scan
‚îú‚îÄ‚îÄ host.json                # Configura√ß√£o do host
‚îú‚îÄ‚îÄ requirements.psd1        # Depend√™ncias PowerShell
‚îú‚îÄ‚îÄ local.settings.json      # Configura√ß√µes locais
‚îú‚îÄ‚îÄ Deploy-Azure.ps1         # Script de deploy automatizado
‚îú‚îÄ‚îÄ Test-NetworkScanner.ps1  # Testes automatizados
‚îî‚îÄ‚îÄ README.md                # Esta documenta√ß√£o
```

## üîß Detec√ß√£o de Sistema Operacional

A detec√ß√£o √© baseada nos valores t√≠picos de TTL:

| Sistema Operacional | TTL T√≠pico | Faixa Aceita |
|-------------------|------------|--------------|
| Windows 10/11/Server | 128 | 120-135 |
| Linux/Unix | 64 | 60-70 |
| Dispositivos de Rede | 255 | 250-255 |

**Nota**: O TTL pode ser decrementado por roteadores, ent√£o a fun√ß√£o considera uma margem de toler√¢ncia.

## üìã Pr√©-requisitos para Windows 11

### Software Necess√°rio

1. **PowerShell 7+**
   ```powershell
   winget install Microsoft.PowerShell
   ```

2. **Azure CLI**
   ```powershell
   winget install Microsoft.AzureCLI
   ```

3. **Azure Functions Core Tools**
   ```powershell
   winget install Microsoft.Azure.FunctionsCoreTools
   # OU
   npm install -g azure-functions-core-tools@4 --unsafe-perm true
   ```

4. **Conta Azure** com permiss√µes para criar recursos

### Verificar Instala√ß√£o

```powershell
# Verificar PowerShell
$PSVersionTable.PSVersion

# Verificar Azure CLI
az --version

# Verificar Functions Core Tools
func --version
```

## üöÄ Deploy no Azure (Windows 11)

### M√©todo 1: Deploy Automatizado (Recomendado)

```powershell
# 1. Fazer login no Azure
az login

# 2. Navegar para o diret√≥rio do projeto
cd network-scanner-powershell

# 3. Executar script de deploy
.\Deploy-Azure.ps1 -NetworkCIDR "10.1.2.0/24" -MaxWorkers 50
```

### M√©todo 2: Deploy Manual

```powershell
# 1. Login no Azure
az login

# 2. Criar grupo de recursos
az group create --name "rg-network-scanner-ps" --location "East US"

# 3. Criar conta de armazenamento
az storage account create `
  --name "stnetscanner$(Get-Random)" `
  --resource-group "rg-network-scanner-ps" `
  --location "East US" `
  --sku Standard_LRS

# 4. Criar Function App PowerShell
az functionapp create `
  --resource-group "rg-network-scanner-ps" `
  --consumption-plan-location "East US" `
  --runtime powershell `
  --runtime-version 7.2 `
  --functions-version 4 `
  --name "func-netscanner-ps-$(Get-Random)" `
  --storage-account "stnetscanner$(Get-Random)" `
  --os-type Windows

# 5. Configurar vari√°veis de ambiente
az functionapp config appsettings set `
  --name "func-netscanner-ps-XXXX" `
  --resource-group "rg-network-scanner-ps" `
  --settings `
    NETWORK_CIDR="10.1.2.0/24" `
    MAX_WORKERS="50" `
    SAVE_DETAILED_RESULTS="false"

# 6. Deploy do c√≥digo
func azure functionapp publish "func-netscanner-ps-XXXX"
```

## üß™ Desenvolvimento Local (Windows 11)

### 1. Configurar Ambiente Local

```powershell
# Clonar/baixar o projeto
cd network-scanner-powershell

# Configurar settings locais (editar local.settings.json)
@{
  "Values" = @{
    "NETWORK_CIDR" = "192.168.1.0/24"
    "MAX_WORKERS" = "30"
    "SAVE_DETAILED_RESULTS" = "false"
  }
} | ConvertTo-Json | Set-Content local.settings.json
```

### 2. Executar Localmente

```powershell
# Iniciar Azure Functions runtime
func start

# A fun√ß√£o estar√° dispon√≠vel em:
# Timer: Executa automaticamente a cada 10 minutos
# HTTP: http://localhost:7071/api/scan
# Health: http://localhost:7071/api/health
```

### 3. Executar Testes

```powershell
# Executar testes automatizados
.\Test-NetworkScanner.ps1

# Teste com verbose
.\Test-NetworkScanner.ps1 -Verbose

# Teste com rede espec√≠fica
.\Test-NetworkScanner.ps1 -TestNetwork "192.168.1.0/28"
```

## üì° API Endpoints

### GET/POST /api/scan
Executa scan manual da rede.

**Par√¢metros Query String:**
- `network`: Rede CIDR (padr√£o: configura√ß√£o da fun√ß√£o)
- `max_workers`: N√∫mero de workers (padr√£o: 50)
- `details`: Incluir detalhes dos hosts (true/false)

**Exemplos PowerShell:**

```powershell
# Scan com par√¢metros padr√£o
Invoke-RestMethod -Uri "https://func-netscanner-ps-XXXX.azurewebsites.net/api/scan" -Method GET

# Scan com rede espec√≠fica
$uri = "https://func-netscanner-ps-XXXX.azurewebsites.net/api/scan?network=192.168.1.0/24&details=true"
Invoke-RestMethod -Uri $uri -Method GET

# POST com JSON
$body = @{
    network = "10.0.0.0/24"
    max_workers = 30
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://func-netscanner-ps-XXXX.azurewebsites.net/api/scan" `
                  -Method POST `
                  -Body $body `
                  -ContentType "application/json"
```

**Exemplo de Resposta:**
```json
{
  "success": true,
  "timestamp": "2024-01-15T10:30:00.000Z",
  "network": "10.1.2.0/24",
  "scan_duration": 2.45,
  "total_hosts_scanned": 254,
  "alive_hosts": 12,
  "os_distribution": {
    "windows": 8,
    "linux": 3,
    "network_device": 1,
    "unknown": 0
  },
  "summary": {
    "windows_count": 8,
    "linux_count": 3,
    "network_devices": 1,
    "unknown_count": 0
  }
}
```

### GET /api/health
Verifica status da fun√ß√£o.

```powershell
Invoke-RestMethod -Uri "https://func-netscanner-ps-XXXX.azurewebsites.net/api/health" -Method GET
```

## üìä Monitoramento (Windows 11)

### Logs em Tempo Real

```powershell
# Ver logs da fun√ß√£o
func azure functionapp logstream "func-netscanner-ps-XXXX"

# Ou via Azure CLI
az webapp log tail --name "func-netscanner-ps-XXXX" --resource-group "rg-network-scanner-ps"
```

### Application Insights

A fun√ß√£o automaticamente envia telemetria para Application Insights. Acesse o portal Azure para:

- M√©tricas de execu√ß√£o
- Logs estruturados
- Alertas personalizados
- Dashboards de monitoramento

### Consultas KQL √öteis

```kql
// Resumos de scan nas √∫ltimas 24 horas
traces
| where timestamp > ago(24h)
| where message contains "SCAN_SUMMARY"
| project timestamp, message
| order by timestamp desc

// Erros nas fun√ß√µes
exceptions
| where timestamp > ago(24h)
| project timestamp, operation_Name, problemId, details
```

## ‚öôÔ∏è Configura√ß√µes Avan√ßadas

### Personalizar Intervalo do Timer

Edite `TimerTrigger/function.json`:

```json
{
  "bindings": [
    {
      "schedule": "0 */5 * * * *"  // A cada 5 minutos
    }
  ]
}
```

Exemplos de schedule:
- `"0 */5 * * * *"` - A cada 5 minutos
- `"0 0 * * * *"` - A cada hora
- `"0 0 9 * * *"` - Diariamente √†s 9:00
- `"0 0 9 * * 1-5"` - Dias √∫teis √†s 9:00

### Ajustar Timeout da Fun√ß√£o

Edite `host.json`:

```json
{
  "functionTimeout": "00:15:00"  // 15 minutos
}
```

### Configurar Alertas (PowerShell)

```powershell
# Criar alerta para falhas
az monitor metrics alert create `
  --name "Network Scanner PS Failures" `
  --resource-group "rg-network-scanner-ps" `
  --scopes "/subscriptions/{subscription-id}/resourceGroups/rg-network-scanner-ps/providers/Microsoft.Web/sites/func-netscanner-ps-XXXX" `
  --condition "count 'requests/failed' > 5" `
  --window-size 5m `
  --evaluation-frequency 1m
```

## üîí Seguran√ßa

### Autentica√ß√£o da API

```powershell
# Habilitar autentica√ß√£o Azure AD
az functionapp auth update `
  --name "func-netscanner-ps-XXXX" `
  --resource-group "rg-network-scanner-ps" `
  --enabled true `
  --action LoginWithAzureActiveDirectory
```

### Rede Virtual

```powershell
# Integrar com VNet
az functionapp vnet-integration add `
  --name "func-netscanner-ps-XXXX" `
  --resource-group "rg-network-scanner-ps" `
  --subnet "/subscriptions/{subscription-id}/resourceGroups/{vnet-rg}/providers/Microsoft.Network/virtualNetworks/{vnet-name}/subnets/{subnet-name}"
```

## üêõ Solu√ß√£o de Problemas

### Problemas Comuns

1. **PowerShell 5.1 vs 7+**
   - Certifique-se de usar PowerShell 7+
   - Verifique: `$PSVersionTable.PSVersion`

2. **Timeout nos pings**
   - Ajustar `MAX_WORKERS` para valor menor
   - Verificar conectividade de rede
   - Aumentar timeout da fun√ß√£o

3. **Fun√ß√£o n√£o executa**
   - Verificar logs no Application Insights
   - Validar configura√ß√£o do timer
   - Verificar permiss√µes de rede

4. **Erro de m√≥dulo n√£o encontrado**
   - Verificar se `Modules/NetworkScanner.ps1` existe
   - Verificar sintaxe do PowerShell

### Debug Local

```powershell
# Executar com logs detalhados
func start --verbose

# Testar fun√ß√£o espec√≠fica
func start --functions TimerTrigger

# Testar m√≥dulo diretamente
. .\Modules\NetworkScanner.ps1
Test-NetworkScanner
```

### Comandos de Diagn√≥stico

```powershell
# Verificar configura√ß√£o da fun√ß√£o
az functionapp config show --name "func-netscanner-ps-XXXX" --resource-group "rg-network-scanner-ps"

# Verificar logs recentes
az functionapp log download --name "func-netscanner-ps-XXXX" --resource-group "rg-network-scanner-ps"

# Testar conectividade
Test-NetConnection -ComputerName "func-netscanner-ps-XXXX.azurewebsites.net" -Port 443
```

## üìà Performance

### Benchmarks T√≠picos

- **Rede /24 (254 IPs)**: ~30-60 segundos
- **Rede /28 (14 IPs)**: ~5-10 segundos
- **Rede /16 (65k IPs)**: ~20-30 minutos

### Otimiza√ß√µes

```powershell
# Para redes grandes, ajustar configura√ß√µes
$env:MAX_WORKERS = "100"        # Mais threads
$env:PING_TIMEOUT = "1000"      # Timeout menor
```

## üîÑ Atualiza√ß√µes e Manuten√ß√£o

### Atualizar C√≥digo

```powershell
# Re-deploy ap√≥s mudan√ßas
func azure functionapp publish "func-netscanner-ps-XXXX"
```

### Backup da Configura√ß√£o

```powershell
# Exportar configura√ß√µes
az functionapp config appsettings list `
  --name "func-netscanner-ps-XXXX" `
  --resource-group "rg-network-scanner-ps" `
  --output json > backup-settings.json
```

## üìù Licen√ßa

Este projeto √© fornecido como exemplo educacional. Adapte conforme suas necessidades espec√≠ficas.

## ü§ù Contribui√ß√µes

Para melhorias ou corre√ß√µes:

1. Teste localmente com `.\Test-NetworkScanner.ps1`
2. Execute os testes automatizados
3. Documente as mudan√ßas
4. Considere impactos de seguran√ßa e performance

## üìû Suporte

- **Issues**: Problemas de configura√ß√£o ou bugs
- **Documenta√ß√£o**: Este README.md
- **Testes**: Execute `.\Test-NetworkScanner.ps1 -Verbose`
- **Logs**: Use Application Insights no portal Azure

